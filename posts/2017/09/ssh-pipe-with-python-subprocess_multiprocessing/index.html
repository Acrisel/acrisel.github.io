<!DOCTYPE html>

<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
<title>SSH Pipe with Python's Subprocess and Multiprocessing - Acrisel's Community Blog</title>
<!-- Using the latest rendering mode for IE -->
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<!-- https://developers.google.com/custom-search/docs/structured_data?hl=es&csw=1#microformats -->
<!--
<PageMap>
<DataObject type="document">
    <Attribute name="title">SSH Pipe with Python's Subprocess and Multiprocessing</Attribute>
    <Attribute name="author">Arnon Sela</Attribute>
    <Attribute name="description">How to pass objects to remote system using SSH and Multiprocessing Synopsis Previous post on this subject used os.fork and os.pipe to issue SSH in a child process. Instead, this post uses multiprocessing Process and Pipe to make it more platform agnostic. Per audience request, this post will …</Attribute>
    <Attribute name="page_count">1</Attribute>
    <Attribute name="rating">5</Attribute>
    <Attribute name="last_update">2017-09-13T22:55:00-05:00</Attribute>
</DataObject>
<DataObject type="metatags">
    <Attribute name="category" value="09"/>
        <Attribute name="category" value="Python"/>
        <Attribute name="category" value="Subprocess"/>
        <Attribute name="category" value="SSH"/>
        <Attribute name="category" value="Pipe"/>
        <Attribute name="category" value="pipeline"/>
        <Attribute name="category" value="distributed"/>
        <Attribute name="category" value="Multiprocessing"/>
        <Attribute name="category" value="fdopen"/>
        <Attribute name="category" value="dup"/>
</DataObject>
-->
<link href="../../../../favicon.ico" rel="icon"/>
<link href="../../../../posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" rel="canonical"/>
<meta content="Arnon Sela" name="author">
<meta content="Python,Subprocess,SSH,Pipe,pipeline,distributed,Multiprocessing,fdopen,dup" name="keywords">
<meta content="How to pass objects to remote system using SSH and Multiprocessing Synopsis Previous post on this subject used os.fork and os.pipe to issue SSH in a child process. Instead, this post uses multiprocessing Process and Pipe to make it more platform agnostic. Per audience request, this post will …" name="description">
<meta content="Acrisel's Community Blog" property="og:site_name"/>
<meta content="article" property="og:type"/>
<meta content="SSH Pipe with Python's Subprocess and Multiprocessing" property="og:title"/>
<meta content="../../../../posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" property="og:url"/>
<meta content="How to pass objects to remote system using SSH and Multiprocessing Synopsis Previous post on this subject used os.fork and os.pipe to issue SSH in a child process. Instead, this post uses multiprocessing Process and Pipe to make it more platform agnostic. Per audience request, this post will …" property="og:description"/>
<meta content="2017-09-13" property="article:published_time"/>
<meta content="09" property="article:section"/>
<meta content="Python" property="article:tag"/>
<meta content="Subprocess" property="article:tag"/>
<meta content="SSH" property="article:tag"/>
<meta content="Pipe" property="article:tag"/>
<meta content="pipeline" property="article:tag"/>
<meta content="distributed" property="article:tag"/>
<meta content="Multiprocessing" property="article:tag"/>
<meta content="fdopen" property="article:tag"/>
<meta content="dup" property="article:tag"/>
<meta content="Arnon Sela" property="article:author"/>
<!-- Bootstrap -->
<link href="../../../../theme/css/bootstrap.cerulean.min.css" rel="stylesheet" type="text/css">
<link href="../../../../theme/css/font-awesome.min.css" rel="stylesheet"/>
<link href="../../../../theme/css/pygments/xcode.css" rel="stylesheet"/>
<link href="../../../../theme/tipuesearch/tipuesearch.css" rel="stylesheet"/>
<link href="../../../../theme/css/html4css1.css" rel="stylesheet"/>
<link href="../../../../theme/css/style.css" rel="stylesheet" type="text/css">
</link></link></meta></meta></meta></head>
<body>
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
<div class="container">
<div class="navbar-header">
<button class="navbar-toggle" data-target=".navbar-ex1-collapse" data-toggle="collapse" type="button">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="../../../../">
Acrisel's Community Blog            </a>
</div>
<div class="collapse navbar-collapse navbar-ex1-collapse">
<ul class="nav navbar-nav">
<li><a href="../../../../pages/welcome-all.html">
</a></li>
<li>
<a href="../../../../category/about-us.html">About us</a>
</li>
<li>
<a href="../../../../category/11.html">11</a>
</li>
<li class="active">
<a href="../../../../category/09.html">09</a>
</li>
<li>
<a href="../../../../category/08.html">08</a>
</li>
<li>
<a href="../../../../category/07.html">07</a>
</li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li><span>
<form action="/search.html" class="navbar-search">
<input class="search-query" id="tipue_search_input" name="q" placeholder="Search" required="" type="text"/>
</form></span>
</li>
</ul>
</div>
<!-- /.navbar-collapse -->
</div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
<div class="row">
<div class="col-sm-9">
<section id="content">
<article>
<header class="page-header">
<h1>
<a href="../../../../posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" rel="bookmark" title="Permalink to SSH Pipe with Python's Subprocess and Multiprocessing">
                        SSH Pipe with Python's Subprocess and Multiprocessing
                    </a>
</h1>
</header>
<div class="entry-content">
<div class="panel">
<div class="panel-body">
<footer class="post-info">
<span class="label label-default">Date</span>
<span class="published">
<i class="fa fa-calendar"></i><time datetime="2017-09-13T22:55:00-05:00"> Wed 13 September 2017</time>
</span>
<span class="label label-default">Modified</span>
<span class="modified">
<i class="fa fa-calendar"></i><time datetime="2017-09-27T08:22:00-05:00"> Wed 27 September 2017</time>
</span>
<span class="label label-default">Tags</span>
<a href="../../../../tag/python.html">Python</a>
        /
	<a href="../../../../tag/subprocess.html">Subprocess</a>
        /
	<a href="../../../../tag/ssh.html">SSH</a>
        /
	<a href="../../../../tag/pipe.html">Pipe</a>
        /
	<a href="../../../../tag/pipeline.html">pipeline</a>
        /
	<a href="../../../../tag/distributed.html">distributed</a>
        /
	<a href="../../../../tag/multiprocessing.html">Multiprocessing</a>
        /
	<a href="../../../../tag/fdopen.html">fdopen</a>
        /
	<a href="../../../../tag/dup.html">dup</a>
</footer><!-- /.post-info --> </div>
</div>
<div class="section" id="how-to-pass-objects-to-remote-system-using-ssh-and-multiprocessing">
<h2>How to pass objects to remote system using SSH and Multiprocessing</h2>
<div class="section" id="synopsis">
<h3>Synopsis</h3>
<p>Previous <a class="reference external" href="https://acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess/">post</a> on this subject used os.fork and os.pipe to issue SSH in a child process. Instead, this post uses multiprocessing Process and Pipe to make it more platform agnostic.  Per audience request, this post will also make use of more object oriented techniques.</p>
</div>
<div class="section" id="motivation">
<h3>Motivation</h3>
<p>A real scenario of using SSH pipeline includes more than just the two endpoints. For example, the initiating end might pass multiprocessing queues to its child process. Such queues can be used to exchange status and controls. Additionally, os.fork is not supported on all platforms.  It would then be beneficial if we use multiprocessing Process and Pipe instead of os.fork and os.pipe respectively.</p>
<p>In this post, we will focus on portable artifacts.</p>
</div>
<div class="section" id="assumptions">
<h3>Assumptions</h3>
<p>Assuming SSH setting and Workload object (class <em>RemoteWorker</em>) are same as in the previous <a class="reference external" href="https://acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess/">post</a>.</p>
</div>
<div class="section" id="ssh-with-multiprocessing-pipe">
<h3>SSH with Multiprocessing Pipe</h3>
<p>The one drawback of os.fork and os.pipe is that they are not supported on all platforms.  For example, os.fork is supported on Unix only. Also, os.fork makes it somewhat more complicated system based objects from parent to child. Hence, we use here multiprocessing Process and Pipe.</p>
<p>The concept here is similar to the one previous <a class="reference external" href="https://acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess/">post</a>; we need to create a pipe with reader and writer on its ends. This time we will use <em>multiprocessing.Pipe()</em> and <em>multiprocessing.Process().  One major difference is the bundling of *agent</em> functions into a class <em>SSHPipe</em>.</p>
<p><em>multiprocessing.Pipe()</em> uses <em>send()</em> and <em>recv()</em> methods to write and read information to the pipe. Since we want to pass pipe reading side as stdin to <em>subprocess</em>, we need need to translate pipe reading end to a regular file. If we do that to one end, we need to do the same to the other end. We accomplish this by using fdopen.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">PIPE</span>
<span class="kn">import</span> <span class="nn">sshtypes</span> <span class="c1"># where RemoteWorker is defined</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>

<span class="k">class</span> <span class="nc">SSHPipe</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">agent_program</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipe_read</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe_write</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pipe</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__communicateq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_program</span> <span class="o">=</span> <span class="n">agent_program</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="s1">''</span> <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="s2">"@</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">user</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__agent</span> <span class="o">=</span>  <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_agent</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">where</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_program</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe_read</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipe_write</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__communicateq</span><span class="p">),</span>
            <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__agent</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">wait</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__agent</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__agent</span><span class="o">.</span><span class="n">exitcode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipe_read</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">agent_program</span><span class="p">,</span> <span class="n">pipe_read</span><span class="p">,</span> <span class="n">pipe_write</span><span class="p">,</span> <span class="n">communicateq</span><span class="p">):</span>
        <span class="n">pipe_write</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pipe_readf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">pipe_read</span><span class="o">.</span><span class="n">fileno</span><span class="p">()),</span> <span class="s1">'rb'</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"ssh"</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="s1">'python'</span><span class="p">,</span> <span class="n">agent_program</span><span class="p">]</span>
        <span class="n">sshrun</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">pipe_readf</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">False</span><span class="p">,)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">(</span><span class="n">sshrun</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">sshrun</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">sshrun</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="n">communicateq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">pipe_readf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">workload</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="n">pack</span><span class="p">:</span>
            <span class="n">workload</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">msgsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">workload</span><span class="p">)</span>
        <span class="n">magsize_packed</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">"&gt;L"</span><span class="p">,</span> <span class="n">msgsize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">magsize_packed</span> <span class="o">+</span> <span class="n">workload</span>

    <span class="k">def</span> <span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__agent</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">pipe_writef</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipe_write</span><span class="o">.</span><span class="n">fileno</span><span class="p">()),</span> <span class="s1">'wb'</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__prepare</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="n">pack</span><span class="p">)</span>
        <span class="n">pipe_writef</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">pipe_writef</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__communicateq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">'TERM'</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__agent</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
</td></tr></table><p>Notes:</p>
<ol class="arabic simple">
<li><em>run_agent()</em> in <em>cmd</em> parameter is using <em>'python'</em> as a medium to run <em>agent_command</em>. If <em>agent_command</em> is executable and is reachable by <em>PATH</em>, then <em>'python'</em> can be omitted.</li>
<li><em>start()</em> method launches <em>run_agent()</em> as a child process, then <em>send()</em> is used to write to pipe.</li>
<li><em>run_agent()</em> child process push response back to parent using <em>Queue</em> (<em>communicateq</em>).</li>
<li><em>close()</em> method is used to close the pipe and send response back.</li>
<li>or, <em>response()</em> method can be used to fetch response off the SSH pipe.</li>
</ol>
<p>Finally, <em>sshremoteagent.py</em> is unchanged in concept from its original pipe form in the previous <a class="reference external" href="https://acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess/">post</a>. This version uses a loop to allow multiple objects to be passed.  Loop will end cleanly once  <em>TERM</em> is received.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">sshtypes</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">msgsize_raw</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">msgsize</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">"&gt;L"</span><span class="p">,</span> <span class="n">msgsize_raw</span><span class="p">)</span>
        <span class="n">workload</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">msgsize</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">workload</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"TERM"</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">worker</span> <span class="o">==</span> <span class="s1">'TERM'</span><span class="p">:</span>
        <span class="c1"># maybe worker prints to stdout</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Bad worker: "</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">worker</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"TERM"</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</td></tr></table><p>Notes:</p>
<ol class="arabic simple">
<li><em>stdout</em> and <em>stderr</em> of <em>sshremoteagent</em> are linked to SSH, therefore, errors are written to stderr.</li>
<li>Return message to SSH Pipe is done via stdout of the remote agent process. The response is transfer once the remote agent ends.</li>
<li>If agent encounters an error, it exits with exitcode 1 or 2 according to the type of error.</li>
<li>Agent also prints out the word <em>TREM</em>, notifying of its termination, as well as an error message to <em>stderr</em> in case of an error.</li>
</ol>
</div>
<div class="section" id="example-usage">
<h3>Example usage</h3>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sshtypes</span>

<span class="n">mp</span><span class="o">.</span><span class="n">set_start_method</span><span class="p">(</span><span class="s1">'spawn'</span><span class="p">)</span>

<span class="n">agent_dir</span> <span class="o">=</span> <span class="s2">"/path/to/program/directory"</span>
<span class="n">agentpy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">agent_dir</span><span class="p">,</span> <span class="s2">"sshremoteagent.py"</span><span class="p">)</span>
<span class="n">host</span> <span class="o">=</span> <span class="s1">'192.168.1.100'</span> <span class="c1"># remote host IP address, or better yet, use host by name.</span>

<span class="n">sshagent</span> <span class="o">=</span> <span class="n">SSHPipe</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">agentpy</span><span class="p">)</span>
<span class="n">sshagent</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">sshagent</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sshagent</span><span class="o">.</span><span class="n">response</span><span class="p">())</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">worker</span> <span class="o">=</span> <span class="n">sshtypes</span><span class="o">.</span><span class="n">RemoteWorker</span><span class="p">()</span>
<span class="n">sshagent</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">sshagent</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">sshagent</span><span class="o">.</span><span class="n">response</span><span class="p">())</span>
    <span class="nb">exit</span><span class="p">()</span>

<span class="n">sshagent</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">sshagent</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s1">'response: '</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="additional-thoughts">
<h3>Additional thoughts</h3>
<p>Using multiprocessing version of SSH pipe banks on its support of multiple platforms. The example usage was made simple.  It can be made more sophisticated (and should be) using <em>try-except</em> clauses. As well as better consideration of the response.</p>
<p>One issue stands out is that remote agent transfers all information at the end of processing. In fact, this might be different on different platforms. One way to work around this is to send back information using another SSH channel in the reversed direction.</p>
<p>In this scenario, the remote agent would start SSH callback agent with source system. When information needs to be passed back to the source, the remote agent will use the callback channel to activate 'response workers'.</p>
</div>
<div class="section" id="references">
<h3>References</h3>
<blockquote>
<div class="line-block">
<div class="line">ssh namedpipes and pipes <a class="reference external" href="https://acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess/">post</a></div>
</div>
</blockquote>
</div>
</div>
</div>
<section class="well" id="post-share-links">
<h4>Share Post:</h4>
<p id="post-share-links">
<a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/&amp;title=SSH%20Pipe%20with%20Python%27s%20Subprocess%20and%20Multiprocessing&amp;summary=How%20to%20pass%20objects%20to%20remote%20system%20using%20SSH%20and%20Multiprocessing%0A%0ASynopsis%0APrevious%20post%20on%20this%20subject%20used%20os.fork%20and%20os.pipe%20to%20issue%20SSH%20in%20a%20child%20process.%20Instead%2C%20this%20post%20uses%20multiprocessing%20Process%20and%20Pipe%20to%20make%20it%20more%20platform%20agnostic.%20%20Per%20audience%20request%2C%20this%20post%20will%20%E2%80%A6&amp;source=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share on Linkedin">Linkedin</a>
        ❄
        <a href="https://sharetodiaspora.github.io/?title=SSH%20Pipe%20with%20Python%27s%20Subprocess%20and%20Multiprocessing&amp;url=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share on Diaspora">Diaspora*</a>
        ❄
        <a href="https://twitter.com/intent/tweet?text=SSH%20Pipe%20with%20Python%27s%20Subprocess%20and%20Multiprocessing&amp;url=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share on Twitter">Twitter</a>
        ❄
        <a href="http://www.facebook.com/sharer/sharer.php?u=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share on Facebook">Facebook</a>
        ❄
        <a href="https://plus.google.com/share?url=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share on Google Plus">Google+</a>
        ❄
        <a href="mailto:?subject=SSH%20Pipe%20with%20Python%27s%20Subprocess%20and%20Multiprocessing&amp;body=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share via Email">Email</a>
</p>
<!--
    <ul>
    <li><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/&title=SSH%20Pipe%20with%20Python%27s%20Subprocess%20and%20Multiprocessing&summary=How%20to%20pass%20objects%20to%20remote%20system%20using%20SSH%20and%20Multiprocessing%0A%0ASynopsis%0APrevious%20post%20on%20this%20subject%20used%20os.fork%20and%20os.pipe%20to%20issue%20SSH%20in%20a%20child%20process.%20Instead%2C%20this%20post%20uses%20multiprocessing%20Process%20and%20Pipe%20to%20make%20it%20more%20platform%20agnostic.%20%20Per%20audience%20request%2C%20this%20post%20will%20%E2%80%A6&source=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share on Diaspora">linkedin*</a></li>
    <li><a href="https://sharetodiaspora.github.io/?title=SSH%20Pipe%20with%20Python%27s%20Subprocess%20and%20Multiprocessing&url=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share on Diaspora">Diaspora*</a></li>
    <li><a href="https://twitter.com/intent/tweet?text=SSH%20Pipe%20with%20Python%27s%20Subprocess%20and%20Multiprocessing&url=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share on Twitter">Twitter</a></li>
    <li><a href="http://www.facebook.com/sharer/sharer.php?u=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share on Facebook">Facebook</a></li>
    <li><a href="https://plus.google.com/share?url=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share on Google Plus">Google+</a></li>
    <li><a href="mailto:?subject=SSH%20Pipe%20with%20Python%27s%20Subprocess%20and%20Multiprocessing&amp;body=https%3A//acrisel.github.io/posts/2017/09/ssh-pipe-with-python-subprocess_multiprocessing/" target="_blank" title="Share via Email">Email</a></li>
    </ul
    -->
</section>
<!-- /.entry-content -->
<section class="well" id="related-posts">
<h4>Other Posts:</h4>
<ul>
<li><a href="../../../../posts/2017/09/ssh-pipe-with-python-subprocess/">SSH Pipe with Python's Subprocess</a></li>
<li><a href="../../../../posts/2017/08/ssh-made-easy-using-python/">SSH Made Easy Using Python Subprocess</a></li>
<li><a href="../../../../posts/2017/09/python-check-remote-host-accessibility/">Remote Host Accessibility</a></li>
<li><a href="../../../../posts/2017/08/python-ordered-class/">Python Ordered Class</a></li>
<li><a href="../../../../posts/2017/07/cobol-conversion-take-1/">Cobol Conversion Take 1</a></li>
</ul>
</section>
<a href="https://plus.google.com/111013214708506107651??rel=author"> </a>
<style>
#pcs-comment-form input,
#pcs-comment-form textarea {
	width: 100%;
}
#pcs-comment-form-display-replyto {
	border: solid 1px black;
	padding: 2px;
}
#pcs-comment-form-display-replyto p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}
#pcs-comments ul {
	list-style: none;
}
#pcs-comments .comment-left {
	display: table-cell;
	padding-right: 10px;
}
#pcs-comments .comment-body {
	display: table-cell;
	vertical-align: top;
	width: 100%;
}
</style>
<section id="pcs-comments">
<header>
<h2>Comments</h2>
<hr/>
</header>
<p>There are no comments yet.</p>
<section>
<form action="#" id="pcs-comment-form">
<legend>Add a Comment</legend>
<input id="pcs-comment-form-input-replyto" type="hidden"/>
<fieldset>
<label for="pcs-comment-form-input-name">Name</label>
<input id="pcs-comment-form-input-name" placeholder="Enter your name or nickname" type="text">
</input></fieldset>
<fieldset>
<label for="pcs-comment-form-input-website">Website</label>
<input id="pcs-comment-form-input-website" placeholder="Enter your website (optional)" type="text">
</input></fieldset>
<fieldset>
<label for="pcs-comment-form-input-textarea">Your Comment</label>
<textarea id="pcs-comment-form-input-textarea" placeholder="Your comment" rows="5" style="resize:vertical;"></textarea>
<p>You can use the <a href="https://en.wikipedia.org/wiki/Markdown">Markdown</a> syntax to format your comment.</p>
<div id="pcs-comment-form-display-replyto" style="display: none; "></div>
</fieldset>
<button id="pcs-comment-form-button-submit" type="submit">Post via email</button>
<!--
			<a href="../../../../feeds/comment.ssh-pipe-with-python-subprocess_multiprocessing.atom.xml">
				Comment Atom Feed
			</a>
        -->
</form>
</section>
</section>
<script src="../../../../theme/js/comments.js" type="text/javascript"></script>
<script type="text/javascript">
		$(document).ready(function() {
			CommentSystem.email_user   = "support";
			CommentSystem.email_domain = "acrisel.com";
			CommentSystem.display_replyto_html = function(comment_content, article_slug, author) {
				return ''
					+ '<button style="float:right;" onclick="CommentSystem.cancelReply(); return false;" title="Cancel the reply">'
					+ 	'×'
					+ '</button>'
					+ '<p>This comment will be posted as a reply to \'<a title="'+comment_content+'" href="#comment-'+article_slug+'">'+author+'</a>\'</p>';
			};

			$('#pcs-comment-form').on("submit",
				function( event )
				{
					event.preventDefault();
					$(location).attr('href', CommentSystem.getMailtoLink("ssh-pipe-with-python-subprocess_multiprocessing"));
				}
			);
		});
	</script>
</article>
</section>
</div>
<div class="col-sm-3" id="sidebar">
<aside>
<!-- Sidebar -->
<section class="well well-sm">
<ul class="list-group list-group-flush">
<!-- Sidebar/Links -->
<li class="list-group-item">
<h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
<ul class="list-group" id="links">
<li class="list-group-item">
<a href="http://www.acrisel.com/" target="_blank">Acrisel</a>
</li>
<li class="list-group-item">
<a href="http://www.github.com/acrisel" target="_blank">Acrisel Open Source</a>
</li>
<li class="list-group-item">
<a href="http://getpelican.com/" target="_blank">Pelican</a>
</li>
<li class="list-group-item">
<a href="http://python.org/" target="_blank">Python.org</a>
</li>
<li class="list-group-item">
<a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a>
</li>
</ul>
</li>
<!-- End Sidebar/Links -->
</ul>
</section>
<!-- End Sidebar --> </aside>
</div>
</div>
</div>
<footer>
<div class="container">
<hr/>
<div class="row">
<div class="col-xs-10">© 2017 Acrisel Team
            · Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a> </div>
<div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
</div>
</div>
</footer>
<script src="../../../../theme/js/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../../../../theme/js/bootstrap.min.js"></script>
<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../../../../theme/js/respond.min.js"></script>
</body>
</html>